# Article Deletion Synchronizations

sync AuthenticateDeleteArticle
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ] => [ request: ?req ]
}
then {
    Web/getAuthToken: [ request: ?req ]
}

sync VerifyDeleteArticleToken
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ] => [ request: ?req ]
    Web/getAuthToken: [ request: ?req ] => [ token: ?token ]
}
then {
    JWT/verify: [ token: ?token ]
}

sync RetrieveArticleForDelete
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ; params: ?params ] => [ request: ?req ]
}
where {
    bind ( ?params["slug"] as ?slug )
}
then {
    Article/getBySlug: [ slug: ?slug ]
}

sync VerifyDeleteOwnership
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Article/getBySlug: [] => [ article: ?articleId ]
}
where {
    Article: { ?articleId author: ?authorId }
    FILTER ( ?userId = ?authorId )
}
then {
    Article/delete: [ article: ?articleId ]
}

sync CascadeDeleteComments
when {
    Article/delete: [] => [ article: ?articleId ]
}
where {
    Comment: { ?commentId article: ?articleId }
}
then {
    Comment/delete: [ comment: ?commentId ]
}

sync CascadeDeleteFavorites
when {
    Article/delete: [] => [ article: ?articleId ]
}
where {
    Favorite: { ?articleId favorites: ?users }
    bind ( ?userId in ?users )
}
then {
    Favorite/remove: [ article: ?articleId ; user: ?userId ]
}

sync RespondDeleteArticleSuccess
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ] => [ request: ?req ]
    Article/delete: [] => [ article: ?articleId ]
}
then {
    Web/respond: [
        request: ?req ;
        status: 204 ;
        body: {} ]
}

sync HandleDeleteArticleNotFound
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ] => [ request: ?req ]
    Article/getBySlug: [] => [ error: ?error ]
}
then {
    Web/respondError: [
        request: ?req ;
        status: 404 ;
        error: "article not found" ]
}

sync HandleDeleteArticleForbidden
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Article/getBySlug: [] => [ article: ?articleId ]
}
where {
    Article: { ?articleId author: ?authorId }
    FILTER ( ?userId != ?authorId )
}
then {
    Web/respondError: [
        request: ?req ;
        status: 403 ;
        error: "forbidden" ]
}
