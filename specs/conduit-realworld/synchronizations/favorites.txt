# Favorite Synchronizations

sync AuthenticateFavoriteArticle
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
}
then {
    Web/getAuthToken: [ request: ?req ]
}

sync VerifyFavoriteToken
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    Web/getAuthToken: [ request: ?req ] => [ token: ?token ]
}
then {
    JWT/verify: [ token: ?token ]
}

sync RetrieveArticleForFavorite
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ; params: ?params ] => [ request: ?req ]
}
where {
    bind ( ?params["slug"] as ?slug )
}
then {
    Article/getBySlug: [ slug: ?slug ]
}

sync FavoriteArticle
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Article/getBySlug: [] => [ article: ?articleId ]
}
then {
    Favorite/add: [ article: ?articleId ; user: ?userId ]
}

sync CheckFavoriteAuthorFollowing
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Favorite/add: [] => [ article: ?articleId ]
}
where {
    Article: { ?articleId author: ?authorId }
}
then {
    Following/isFollowing: [ follower: ?userId ; target: ?authorId ]
}

sync RespondFavoriteSuccess
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Favorite/add: [] => [ article: ?articleId ]
    Following/isFollowing: [] => [ following: ?following ]
}
where {
    Article: { ?articleId slug: ?slug ; title: ?title ; description: ?description ; body: ?bodyText ; author: ?authorId ; createdAt: ?createdAt ; updatedAt: ?updatedAt }
    User: { ?authorId username: ?username ; bio: ?bio ; image: ?image }
    Tag: { ?articleId tagList: ?tagList }
    Favorite: { ?articleId count: ?favoritesCount }
}
then {
    Web/respond: [
        request: ?req ;
        status: 200 ;
        body: {
            "article": {
                "slug": ?slug,
                "title": ?title,
                "description": ?description,
                "body": ?bodyText,
                "tagList": ?tagList,
                "createdAt": ?createdAt,
                "updatedAt": ?updatedAt,
                "favorited": true,
                "favoritesCount": ?favoritesCount,
                "author": {
                    "username": ?username,
                    "bio": ?bio,
                    "image": ?image,
                    "following": ?following
                }
            }
        } ]
}

sync HandleFavoriteArticleNotFound
when {
    Web/request: [ method: "POST" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    Article/getBySlug: [] => [ error: ?error ]
}
then {
    Web/respondError: [
        request: ?req ;
        status: 404 ;
        error: "article not found" ]
}

sync AuthenticateUnfavoriteArticle
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
}
then {
    Web/getAuthToken: [ request: ?req ]
}

sync VerifyUnfavoriteToken
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    Web/getAuthToken: [ request: ?req ] => [ token: ?token ]
}
then {
    JWT/verify: [ token: ?token ]
}

sync RetrieveArticleForUnfavorite
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ; params: ?params ] => [ request: ?req ]
}
where {
    bind ( ?params["slug"] as ?slug )
}
then {
    Article/getBySlug: [ slug: ?slug ]
}

sync UnfavoriteArticle
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Article/getBySlug: [] => [ article: ?articleId ]
}
then {
    Favorite/remove: [ article: ?articleId ; user: ?userId ]
}

sync CheckUnfavoriteAuthorFollowing
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Favorite/remove: [] => [ article: ?articleId ]
}
where {
    Article: { ?articleId author: ?authorId }
}
then {
    Following/isFollowing: [ follower: ?userId ; target: ?authorId ]
}

sync RespondUnfavoriteSuccess
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?userId ]
    Favorite/remove: [] => [ article: ?articleId ]
    Following/isFollowing: [] => [ following: ?following ]
}
where {
    Article: { ?articleId slug: ?slug ; title: ?title ; description: ?description ; body: ?bodyText ; author: ?authorId ; createdAt: ?createdAt ; updatedAt: ?updatedAt }
    User: { ?authorId username: ?username ; bio: ?bio ; image: ?image }
    Tag: { ?articleId tagList: ?tagList }
    Favorite: { ?articleId count: ?favoritesCount }
}
then {
    Web/respond: [
        request: ?req ;
        status: 200 ;
        body: {
            "article": {
                "slug": ?slug,
                "title": ?title,
                "description": ?description,
                "body": ?bodyText,
                "tagList": ?tagList,
                "createdAt": ?createdAt,
                "updatedAt": ?updatedAt,
                "favorited": false,
                "favoritesCount": ?favoritesCount,
                "author": {
                    "username": ?username,
                    "bio": ?bio,
                    "image": ?image,
                    "following": ?following
                }
            }
        } ]
}

sync HandleUnfavoriteArticleNotFound
when {
    Web/request: [ method: "DELETE" ; path: "/api/articles/:slug/favorite" ] => [ request: ?req ]
    Article/getBySlug: [] => [ error: ?error ]
}
then {
    Web/respondError: [
        request: ?req ;
        status: 404 ;
        error: "article not found" ]
}
