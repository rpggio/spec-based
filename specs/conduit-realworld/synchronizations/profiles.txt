# Profile Viewing and Following Synchronizations

sync GetProfileUnauthenticated
when {
    Web/request: [ method: "GET" ; path: "/api/profiles/:username" ; params: ?params ] => [ request: ?req ]
}
where {
    bind ( ?params["username"] as ?username )
}
then {
    Profile/get: [ username: ?username ]
}

sync RespondProfileUnauthenticated
when {
    Web/request: [ method: "GET" ; path: "/api/profiles/:username" ] => [ request: ?req ]
    Profile/get: [] => [ user: ?userId ; username: ?username ; bio: ?bio ; image: ?image ]
}
then {
    Web/respond: [
        request: ?req ;
        status: 200 ;
        body: {
            "profile": {
                "username": ?username,
                "bio": ?bio,
                "image": ?image,
                "following": false
            }
        } ]
}

sync GetProfileAuthenticated
when {
    Web/request: [ method: "GET" ; path: "/api/profiles/:username" ; params: ?params ] => [ request: ?req ]
    Web/getAuthToken: [ request: ?req ] => [ token: ?token ]
    JWT/verify: [ token: ?token ] => [ user: ?viewerId ]
}
where {
    bind ( ?params["username"] as ?username )
}
then {
    Profile/view: [ viewer: ?viewerId ; username: ?username ]
}

sync RespondProfileAuthenticated
when {
    Web/request: [ method: "GET" ; path: "/api/profiles/:username" ] => [ request: ?req ]
    Profile/view: [] => [ user: ?userId ; username: ?username ; bio: ?bio ; image: ?image ; following: ?following ]
}
then {
    Web/respond: [
        request: ?req ;
        status: 200 ;
        body: {
            "profile": {
                "username": ?username,
                "bio": ?bio,
                "image": ?image,
                "following": ?following
            }
        } ]
}

sync AuthenticateFollowRequest
when {
    Web/request: [ method: "POST" ; path: "/api/profiles/:username/follow" ] => [ request: ?req ]
}
then {
    Web/getAuthToken: [ request: ?req ]
}

sync VerifyFollowToken
when {
    Web/request: [ method: "POST" ; path: "/api/profiles/:username/follow" ] => [ request: ?req ]
    Web/getAuthToken: [ request: ?req ] => [ token: ?token ]
}
then {
    JWT/verify: [ token: ?token ]
}

sync FollowUser
when {
    Web/request: [ method: "POST" ; path: "/api/profiles/:username/follow" ; params: ?params ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?followerId ]
}
where {
    bind ( ?params["username"] as ?username )
    User: { ?targetUser username: ?username }
}
then {
    Following/follow: [ follower: ?followerId ; target: ?targetUser ]
}

sync RespondFollowSuccess
when {
    Web/request: [ method: "POST" ; path: "/api/profiles/:username/follow" ] => [ request: ?req ]
    Following/follow: [] => [ follower: ?followerId ; target: ?targetUser ]
}
where {
    User: { ?targetUser username: ?username ; bio: ?bio ; image: ?image }
}
then {
    Web/respond: [
        request: ?req ;
        status: 200 ;
        body: {
            "profile": {
                "username": ?username,
                "bio": ?bio,
                "image": ?image,
                "following": true
            }
        } ]
}

sync AuthenticateUnfollowRequest
when {
    Web/request: [ method: "DELETE" ; path: "/api/profiles/:username/follow" ] => [ request: ?req ]
}
then {
    Web/getAuthToken: [ request: ?req ]
}

sync VerifyUnfollowToken
when {
    Web/request: [ method: "DELETE" ; path: "/api/profiles/:username/follow" ] => [ request: ?req ]
    Web/getAuthToken: [ request: ?req ] => [ token: ?token ]
}
then {
    JWT/verify: [ token: ?token ]
}

sync UnfollowUser
when {
    Web/request: [ method: "DELETE" ; path: "/api/profiles/:username/follow" ; params: ?params ] => [ request: ?req ]
    JWT/verify: [] => [ user: ?followerId ]
}
where {
    bind ( ?params["username"] as ?username )
    User: { ?targetUser username: ?username }
}
then {
    Following/unfollow: [ follower: ?followerId ; target: ?targetUser ]
}

sync RespondUnfollowSuccess
when {
    Web/request: [ method: "DELETE" ; path: "/api/profiles/:username/follow" ] => [ request: ?req ]
    Following/unfollow: [] => [ follower: ?followerId ; target: ?targetUser ]
}
where {
    User: { ?targetUser username: ?username ; bio: ?bio ; image: ?image }
}
then {
    Web/respond: [
        request: ?req ;
        status: 200 ;
        body: {
            "profile": {
                "username": ?username,
                "bio": ?bio,
                "image": ?image,
                "following": false
            }
        } ]
}

sync HandleProfileNotFound
when {
    Web/request: [ method: "GET" ; path: "/api/profiles/:username" ] => [ request: ?req ]
    Profile/get: [] => [ error: ?error ]
}
then {
    Web/respondError: [
        request: ?req ;
        status: 404 ;
        error: "profile not found" ]
}
